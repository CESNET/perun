include:
  - project: perun/common
    file: /templates/.gitlab-ci-template.yml

# use same rules as in .releaserc.json
semantic-release:
  rules:
    - if: '$CI_COMMIT_REF_NAME == "production" && $CI_PIPELINE_SOURCE != "schedule"'
    - if: '$CI_COMMIT_REF_NAME =~ /^[0-9]+(\.([0-9]+|x))?\.x$/ && $CI_PIPELINE_SOURCE != "schedule"'

# build and run tests
maven-build:
  image: $CI_DEPENDENCY_PROXY_DIRECT_GROUP_IMAGE_PREFIX/ubuntu:latest@sha256:2b7412e6465c3c7fc5bb21d3e6f1917c167358449fecac8176c6e496e5c1f05f
  stage: build
  tags: # do not run on k8s
    - docker
    - privileged
  before_script:
    - apt update -y
    - apt install -yqq openjdk-17-jdk-headless maven docker openssh-client
  script:
    - mvn -B -Dmaven.repo.local=.m2/repository clean install
  rules:
    - if: "$CI_PIPELINE_SOURCE != 'schedule'"
